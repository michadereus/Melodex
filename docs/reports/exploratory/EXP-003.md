# EXP-03 – Exploratory Session – Cross-Account OAuth Isolation

**Date:** `2025-11-13`  
**Build/Commit:** `4db0a3e`  
**Environment:** Local (Windows 11), Node 20, Frontend `http://localhost:3001`, Backend `http://localhost:3001`  

**Charter:**  
Investigate how Spotify OAuth behaves when switching Melodex user accounts within the same browser session. Confirm whether Spotify login, consent, and `/auth/session` are properly isolated per Melodex account, and whether exports trigger the correct Spotify account prompts after switching users.

## Setup  
- Two Melodex accounts available (`User A`, `User B`).  
- Logged into Spotify under `User A` initially.  
- Switched Melodex accounts via the app’s Google login flow.  
- DevTools Network open; backend running with `LOG_LEVEL=debug`.  
- Cleared Melodex local storage between runs, but did not clear browser-level Spotify cookies to replicate real-world switching behavior.

## Heuristics  
- **Session isolation:** Verify that app-level user identity is not confused with stored provider-level identity.  
- **Auth transitions:** Melodex logout → Melodex login (different user) → export.  
- **Prompt oracle:** Expect Spotify to re-prompt login if the active Melodex user has not granted scopes.  
- **State modeling:** Compare `/auth/session` before and after user switch.

## Notes & Findings  
- Switching from `User A` → `User B` did **not** trigger any Spotify login/consent prompt during export.  
- `/auth/session` returned `connected:true` for `User B` immediately, even though `User B` had never connected a Spotify account.  
- Export proceeded using the **Spotify account linked to User A**.  
- No disconnect step was triggered during Melodex logout, leaving provider cookies active.  
- Re-initializing `User B`’s session relied entirely on existing Spotify browser cookies instead of enforcing per-account authorization.

### Evidence  
- Network traces:  
  - `/auth/session` responses showing `connected:true` immediately after account switch.  
  - `/auth/start` not called when initiating export under `User B`.  
- Console logs indicating session reuse.  
- Screenshots: `screenshots/exp03-session-reuse.png`  
- Backend log excerpt: `logs/exp03-oauth-reuse.txt`

## Bugs  
- **DEF-006 — Spotify OAuth session leaks between Melodex accounts**  
  _Repro:_ Log in as Melodex User A → authenticate Spotify → log out → log in as Melodex User B → initiate export → Spotify login not prompted; export uses User A’s Spotify account.  
  _Impact:_ Incorrect playlists are created under the wrong Spotify user; severe cross-account authorization leak.  
  _Severity:_ Critical  
  _Status:_ Open  
  _Report:_ [DEF-006](../defects/DEF-006.md)  
  _PR:_ *(pending)*  

## Learned  
- Melodex logout does not clear provider (Spotify) cookies or invalidate backend-side tokens.  
- `/auth/session` trusts existing provider cookies too easily, causing cross-account assumptions.  
- OAuth state must be bound to the **Melodex user**, not the browser session.  
- Proper session invalidation on logout is required to enforce correct provider identity.  

## Risks  
- Cross-account playlist creation under the wrong Spotify account.  
- Violations of expected OAuth isolation (auth related).  
- Inconsistent UX: some flows prompt login, others silently reuse outdated cookies.  
- Potential non-compliance with Spotify's terms regarding user identity and token usage.

## Outcome  
- **Status:** Completed  
- **Follow-ups:**  
  - Implement forced token invalidation on Melodex logout (clear backend cookies + provider tokens).  
  - Add `/auth/session` hardening so one user’s session cannot be reused for another.  
  - Add regression coverage:  
    - Logging out + logging in with new user requires Spotify login.  
    - Export uses correct Spotify identity after user switch.  
  - Create and track DEF-006; incorporate into auth hardening plan.  
