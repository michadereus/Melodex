# DEF-004 — Post-Spotify consent returns to /rankings without auto-opening Export

## Summary
After approving Spotify access (login + consent), the app redirects back to `/rankings` but **lands on the standard Rankings view**. The user must click **Export to Spotify** a second time to reopen the export UI. Expected behavior for this flow is to **auto-open the Export panel/modal** when returning from OAuth so the user continues the export they initiated.

## Environment
- App: Melodex (local dev; Amplify redirect override observed)
- Commit: *(local dev — current HEAD, hash unknown)*
- Browser: Firefox (desktop)
- Device: Windows 11 laptop
- Network: Spectrum (~450 up / 11 down)
- Date/Time: 11-10-2025 (America/Chicago)

## Preconditions
- User has a valid Spotify account.
- User begins export from `/rankings` (checkbox selections and optional description present).

## Steps to Reproduce
1. On `/rankings`, click **Export to Spotify**.
2. In the Spotify pane, log in and click **Agree** to grant requested scopes.
3. Observe redirect back to the app at `/rankings`.

## Expected Result
- App should **resume the export flow automatically**: Export UI (panel/modal) opens on return from OAuth with prior state (checked items, name/description) intact.

## Actual Result
- Page returns to `/rankings` but shows the **standard Rankings view**.
- User must click **Export to Spotify** again to proceed.

## Impact
- Adds friction and confusion in a critical conversion path.
- Risk of losing user context (e.g., description text, which checkboxes were toggled) if state is not fully preserved.
- Increases abandonment likelihood if coupled with subsequent export errors.

## Attachments
- Console snippet: `Local dev: overriding Amplify redirect URLs`
- Session narrative with timestamps (see exploratory notes)

## Triage
- Severity: **Minor → Major** (minor UX when state is preserved; **major** if state is lost)
- Priority: **High** (affects every first-time or re-auth export)

## Suspected Areas
- OAuth callback handling: missing/ignored **returnTo / intent** parameter.
- Router state restore on `/rankings` (export intent flag not triggering).
- `Rankings.jsx` export state (`selectionMode` / “export view” flag) not re-hydrated post-consent.
- Race between auth/session fetch and UI state activation.

## Diagnostics (what we tried)
- Reproduced consistently with personal Spotify account.
- Observed successful `/auth/session` (200) immediately prior to manual second click.
- Confirmed redirect lands on `/rankings` without export UI automatically opening.

## Proposed Fix (initial)
- Carry an **explicit export intent** through the OAuth round-trip (e.g., query param/state).
- On callback, if **intent=export**, programmatically open Export UI and re-bind previous selections/name/description.
- Add regression coverage:
  - **IT/E2E:** “Return from OAuth resumes export UI without extra click.”

---

**Owner:** Michael DeReus  
**Status:** Open  
**Opened:** 11-10-2025

### Linked Items
- Risk: R-12 (Auth round-trip loses user flow)
- Tests: SMK-OAuth-Resume (to add), E2E-Export-OAuth-Resume (to add)

---

## Root Cause (fill after fix)
*TBD*

## Fix Reference
*TBD*

## Verification Steps (post-fix)
1. Start export → OAuth consent → return to app.
2. Verify Export UI opens automatically with preserved selections/name/description.
3. No additional click required to proceed to **Create playlist**.
