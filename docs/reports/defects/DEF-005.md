# DEF-005 — Export consistently fails with 502 on `/api/playlist/export`

## Summary
Attempting to export a playlist from `/rankings` results in a consistent failure. UI displays:  
**“Export failed: Failed to create playlist on Spotify. — Please retry or adjust your selection.”**  
Retry action does not recover. Backend logs show **502** responses on `POST /playlist/export` (called via `/api/playlist/export`).

## Environment
- App: Melodex (local dev; Amplify redirect override observed)
- Commit: *(local dev — current HEAD, hash unknown)*
- Browser: Firefox (desktop)
- Device: Windows 11 laptop
- Network: Spectrum (~450 up / 11 down)
- Date/Time: 11-10-2025 (America/Chicago)

## Preconditions
- Spotify login completed; `/auth/session` returns **200**.
- On `/rankings`, some songs checked/unchecked; playlist description entered.

## Steps to Reproduce
1. From `/rankings`, click **Export to Spotify** (after successful login/consent).
2. Uncheck several songs and enter a description.
3. Click **Export**.
4. Observe error toast/dialog; click **Retry**.

## Expected Result
- Server creates a playlist on Spotify and returns a success envelope with `playlistUrl`.
- UI shows success link; retry only needed for transient failures (e.g., 429 with backoff).

## Actual Result
- UI error: **“Failed to create playlist on Spotify.”**
- **Retry** does nothing; error repeats.
- API logs:
  - `GET /auth/session` → **200**
  - `POST /api/playlist/export` → **502**
  - `POST /api/playlist/export` (on retry) → **502**

## Impact
- **Core feature blocked**; users cannot export playlists at all in this environment.
- Repeated 502s degrade trust and waste user time.
- Prevents further validation of per-track error surfaces and progress UX.

## Attachments
- Screenshots: [Export error](../evidence/DEF-005-export.png)

## Triage
- Severity: **Blocker**
- Priority: **Urgent**

## Suspected Areas
- Backend **/playlist/export** path:
  - Upstream gateway error to Spotify (network/DNS, TLS, outage, bad base URL).
  - **Auth scope/token** issues (e.g., missing `playlist-modify-private/public`, expired token, tenant mismatch).
  - Environment mismatch (local dev vs registered Spotify redirect URIs; observed Amplify redirect override).
  - Request payload contract drift (name/description/URIs shape) or owner resolution (Spotify user ID).
  - Mapping mode/config producing empty/invalid chunks (should still not be 502, but may trigger backend error).
- Error handling:
  - 502 may be our server’s proxy error; details not surfaced to client; retry path not switching strategy.

## Diagnostics (what we tried)
- Reproduced with various selections (all checked / some unchecked), different descriptions/names.
- Tried switching Spotify accounts and genres with fewer songs.
- Consistent 502s; UI retry repeats same failure.
- Verified `/auth/session` **200** directly before export attempts.

## Proposed Fix (initial)
*Investigation checklist (no code change yet):*
1. Inspect server logs for **root error** on `/playlist/export` (stack trace / upstream status from Spotify).
2. Confirm **Spotify scopes** present and token is valid (ensure consent covered `playlist-modify-private` or public).
3. Validate **redirect URIs / app IDs** used in local dev match Spotify app config.
4. Log and verify **request body** we send to Spotify’s Create Playlist endpoint (owner ID, name, description).
5. Confirm **mapping/output** yields a non-empty `kept` array and chunking ≤100 tracks.
6. Add temporary diagnostics: capture upstream status/error body to differentiate gateway vs application errors.
7. If upstream transient, ensure **backoff/retry** policy applies (but 502 + immediate retry loop currently not recovering).

---

**Owner:** Michael DeReus  
**Status:** Open  
**Opened:** 11-10-2025

### Linked Items
- Risks: R-07 (3rd-party API failure), R-09 (OAuth scope drift)
- Tests to (re)run after fix: IT-004/005/008/011, E2E-001/004/007/009

---

## Root Cause (fill after fix)
*TBD*

## Fix Reference
*TBD*

## Verification Steps (post-fix)
1. Start export with 15–30 items; confirm `POST /api/playlist/export` → **200** and UI shows success link.
2. Repeat with subset selection and description; confirm playlist metadata applied.
3. Validate negative cases (429, NOT_FOUND) still follow the established envelope and UX.
