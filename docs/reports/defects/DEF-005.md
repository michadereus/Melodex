# DEF-005 — Export consistently fails with 502 on `/api/playlist/export`

## Summary
Attempting to export a playlist from `/rankings` resulted in a consistent failure.  
UI displayed:  
**“Export failed: Failed to create playlist on Spotify. — Please retry or adjust your selection.”**  
Retries did not recover.  
Backend logs showed repeated **502** responses on `POST /playlist/export` (proxied through `/api/playlist/export`).

## Environment
- **App:** Melodex (local dev; Amplify redirect override observed)  
- **Commit:** *(local dev — current HEAD, hash unknown)*  
- **Browser:** Firefox (desktop)  
- **Device:** Windows 11 laptop  
- **Network:** Spectrum (~450 up / 11 down)  
- **Date/Time:** 2025-11-10 (America/Chicago)

## Preconditions
- Spotify login completed; `/auth/session` → 200 (connected true).  
- On `/rankings`, several songs selected/unselected, description entered.

## Steps to Reproduce
1. On `/rankings`, click **Export to Spotify** after successful login/consent.  
2. Uncheck several songs and enter a description.  
3. Click **Export**.  
4. Observe the error toast/dialog; click **Retry**.

## Expected Result
- Server creates a playlist on Spotify and returns a success envelope with `playlistUrl`.  
- UI displays success link; retries only required for transient errors (e.g., 429).

## Actual Result
- UI error: **“Failed to create playlist on Spotify.”**  
- Retry reproduces same error.  
- API log sequence:
  - `GET /auth/session` → 200  
  - `POST /api/playlist/export` → 502  
  - Repeated attempts → 502

## Impact
- **Blocker** — users unable to export any playlists.  
- Prevented validation of per-track error surfaces and progress UX.

## Attachments
- Screenshots: [Export error](../evidence/DEF-005-export.png), [Unexpected response error](DEF-005-export-unexpected-response.png)
- HAR: [Session auth 200 fix](DEF-005-session-200.png)

## Triage
- **Severity:** Blocker  
- **Priority:** Urgent  

## Suspected Areas
- Backend `/playlist/export`:
  - Upstream Spotify 403/400/502 propagation.  
  - Missing `playlist-modify-private` scope or expired token.  
  - Stub fallback (`pl_stub`) incorrectly used in real mode.  
  - Mapping returning invalid/stub URIs → Spotify 400 “Invalid base62 id”.  
  - Error-handling path collapsing all upstream errors into 502.

## Diagnostics (what we tried)
- Retested with multiple selections and descriptions.  
- Switched Spotify accounts.  
- Verified `/auth/session` 200 before each export.  
- 502s reproducible every time.  
- Added `EXPORT_STUB=off` and captured full HAR + server logs.

## Proposed Fix (initial investigation)
1. Inspect backend logs to capture upstream Spotify error body/status.  
2. Confirm Spotify scopes (`playlist-modify-private`).  
3. Validate redirect URIs vs Spotify app registration.  
4. Verify payload to `/v1/me/playlists` and subsequent `/tracks`.  
5. Ensure mapping outputs valid Spotify URIs.  
6. Add structured error envelope instead of 502.  
7. Re-apply rate-limit backoff policy.

---

**Owner:** Michael DeReus  
**Status:** Resolved  
**Opened:** 2025-11-10  
**Closed:** 2025-11-11  

### Linked Items
- **Future Tech Story:** TS-04 — Spotify track lookup (real mapper)  
- **Risks:** R-07 (3rd-party API failure), R-09 (OAuth scope drift)  
- **Tests to re-run:** IT-004/005/008/011, E2E-001/004/007/009
- **New test:** IT-014-export-manual-stub.spec.ts

---

## Root Cause (confirmed)
- `/api/playlist/export` mixed stub and real logic:
  - In real mode, invalid or stub URIs (`spotify:track:pl_stub`) were sent to Spotify.  
  - Spotify returned `400 Invalid base62 id`; backend bubbled up 502.  
- Missing URI validation and playlist ID sanity checks.  
- Real mapper returned no valid Spotify URIs, so export always failed.

## Fix Reference
- Commit: *(local dev; AuthController.js patched)*  
- PR: 

## Changes:
  - **Added stub vs real branching** (`EXPORT_STUB` runtime flag).  
  - **Strict URI validation** (`/^spotify:track:[A-Za-z0-9]{22}$/`).  
  - **Skip invalid URIs** instead of sending to Spotify.  
  - **Reject non-base62 playlist IDs.**  
  - **Improved error envelopes:** 502 → typed `SPOTIFY_FAIL` or `NO_SONGS`.  
  - **Stub mode** returns deterministic `pl_stub` envelope for exploratory testing.  

## Verification Steps (post-fix)
1. Run export with `EXPORT_STUB=on` → `200 ok:true` and `playlistId:"pl_stub"`.  
2. Run export with `EXPORT_STUB=off` → `200 ok:false` `code:"NO_SONGS"` (expected until mapper implemented).  
3. Confirm no 502 responses or uncaught errors in server logs.  
4. UI handles structured error gracefully (“No songs could be mapped”).  
5. Real Spotify playlist creation pending new technical story (TS-07).  
